<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Learn English</title>
<link rel="stylesheet" href="style.css">
<script src="menuLpader"></script>
</head>


<!-- –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é -->
<button class="menu__btn" id="menuBtn">‚ò∞ –ú–µ–Ω—é</button>
<ul class="menu__nav" id="menuDropdown">
  <!-- –ö–Ω–æ–ø–∫–∞ ¬´–ú–æ–π —Å–ª–æ–≤–∞—Ä—å¬ª -->
  <li class="menu__nav-item">
    <button class="level-btn" id="myDictionaryBtn">–ú–æ–π —Å–ª–æ–≤–∞—Ä—å</button>
  </li>
</ul>

<div id="lessonContent">
  <div id="progressText"></div>
  <div id="progressBarContainer">
    <div id="progressBar">0%</div>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 0: —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π –≤–≤–æ–¥ —Å–ª–æ–≤ -->
  <div id="page0">
    <h2>–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞ (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</h2>
    <textarea id="englishWords" rows="8" placeholder="cat&#10;dog&#10;pig"></textarea><br>
    <button onclick="goToTranscription()">–î–∞–ª—å—à–µ</button>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 1: —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ -->
  <div id="page1_5" class="hidden">
    <h2>–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)</h2>
    <textarea id="englishTranscription" rows="8" placeholder="k√¶t&#10;d…íg&#10;p…™g"></textarea><br>
    <button onclick="skipTranscription()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
    <button onclick="goToTranslations()">–î–∞–ª—å—à–µ</button>
  </div>

  <!-- –°—Ç—Ä–∞–Ω–∏—Ü–∞ 2: –ø–µ—Ä–µ–≤–æ–¥—ã -->
  <div id="page2" class="hidden">
    <h2>–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥—ã (–ø–æ –æ–¥–Ω–æ–º—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)</h2>
    <textarea id="translatedWords" rows="8" placeholder="–∫–æ—Ç&#10;—Å–æ–±–∞–∫–∞&#10;—Å–≤–∏–Ω—å—è"></textarea><br>
    <button onclick="startSelfLearning()">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
  </div>

  <!-- –§–∞–∑—ã –æ–±—É—á–µ–Ω–∏—è -->
  <div id="page3" class="hidden">
    <h2>–§–∞–∑–∞ 1: –û–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ</h2>
    <p id="card">
      <span id="cardWord"></span>
      <button id="addToDictionaryBtn" class="dictionary-btn">‚òÜ</button>
    </p>
    <div class="example" id="cardExample"></div>
    <button onclick="showNextCard()">–î–∞–ª–µ–µ</button>
    <button onclick="repeatPhase()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —ç—Ç–∞–ø</button>
    <button onclick="goToNextPage()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø</button>
  </div>

  <div id="page4" class="hidden">
    <h2>–§–∞–∑–∞ 2: –ü–µ—Ä–µ–≤–æ–¥ ‚Üí –û—Ä–∏–≥–∏–Ω–∞–ª</h2>
    <p id="phase2-translation">
      <span id="phase2Word"></span>
      <button id="addToDictionaryBtn2" class="dictionary-btn">‚òÜ</button>
    </p>
    <div class="example" id="phase2-example"></div>
    <button id="showAnswerBtn" onclick="showAnswer()">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
    <div id="answerSection" class="hidden">
      <p id="phase2-answer"></p>
      <button onclick="markAnswer(true)">‚úÖ</button>
      <button onclick="markAnswer(false)">‚ùå</button>
      <button onclick="repeatPhase()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —ç—Ç–∞–ø</button>
      <button onclick="goToNextPage()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø</button>
    </div>
  </div>

  <div id="page5" class="hidden">
    <h2>–§–∞–∑–∞ 3: –û—Ä–∏–≥–∏–Ω–∞–ª ‚Üí –ü–µ—Ä–µ–≤–æ–¥</h2>
    <p id="phase3-original">
      <span id="phase3Word"></span>
      <button id="addToDictionaryBtn3" class="dictionary-btn">‚òÜ</button>
    </p>
    <div class="example" id="phase3-example"></div>
    <button id="showAnswerBtn3" onclick="showAnswer3()">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
    <div id="answerSection3" class="hidden">
      <p id="phase3-answer"></p>
      <button onclick="markAnswer3(true)">‚úÖ</button>
      <button onclick="markAnswer3(false)">‚ùå</button>
      <button onclick="repeatPhase()">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —ç—Ç–∞–ø</button>
      <button onclick="goToNextPage()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø</button>
    </div>
  </div>

  <div id="page6" class="hidden">
    <h2>–§–∞–∑–∞ 4: –î–∏–∫—Ç–∞–Ω—Ç</h2>
    <p id="dictation-translation"></p>
    <div class="example" id="dictation-example"></div>
    <input type="text" id="dictation-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ" autocomplete="off">
    <button onclick="checkDictation()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
    <button onclick="nextDictationAfterError()">–°–ª–µ–¥—É—é—â–µ–µ</button>
    <p id="dictation-feedback"></p>
  </div>

  <div id="finishPage" class="hidden">
    <h2>üéâ –£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω!</h2>
    <button onclick="backToMenu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–µ–Ω—é</button>
  </div>
</div>

<script>

  // === –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ === 
let lessonsDB = {};
let currentLesson = null;
let currentLessonElement = null;
let words = [];
let transcriptions = [];
let translations = [];
let examples = [];
let currentPhase = 0;
let currentIndex = 0;
let wrongQueue = [];
let dictationQueue = [];
let dictationWaiting = false;
let pullExamplesFromJSON = true; // –ø–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å –ø—Ä–∏–º–µ—Ä—ã –∏–∑ JSON
let lastSpokenWord = "";
let slowMode = false;

// === LocalStorage: —Å–ª–æ–≤–∞—Ä—å –∏ –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–µ —É—Ä–æ–∫–∏ ===
const LOCAL_STORAGE_KEY = "myDictionary";
const FINISHED_LESSONS_KEY = "finishedLessons";

function getMyDictionary() {
  const dict = localStorage.getItem(LOCAL_STORAGE_KEY);
  return dict ? JSON.parse(dict) : [];
}

function saveMyDictionary(dict) {
  localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dict));
}

function getFinishedLessons() {
  const finished = localStorage.getItem(FINISHED_LESSONS_KEY);
  return finished ? JSON.parse(finished) : {};
}

function saveFinishedLesson(level, lessonKey) {
  const finished = getFinishedLessons();
  if (!finished[level]) finished[level] = [];
  if (!finished[level].includes(lessonKey)) finished[level].push(lessonKey);
  localStorage.setItem(FINISHED_LESSONS_KEY, JSON.stringify(finished));
}

// === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ–≤–∞—Ä—è ===
function isInDictionary(word) {
  return getMyDictionary().includes(word);
}

function toggleDictionary(word, button) {
  let dict = getMyDictionary();
  if (dict.includes(word)) {
    dict = dict.filter(w => w !== word);
    button.textContent = "‚òÜ";
  } else {
    dict.push(word);
    button.textContent = "‚òÖ";
  }
  saveMyDictionary(dict);
}

// === –û–∑–≤—É—á–∫–∞ ===
function speakWord(word) {
  if (!word) return;
  const utter = new SpeechSynthesisUtterance(word);
  utter.lang = "en-US";
  utter.rate = slowMode ? 0.7 : 1.0;
  speechSynthesis.cancel();
  speechSynthesis.speak(utter);
  slowMode = (lastSpokenWord === word) ? !slowMode : false;
  lastSpokenWord = word;
}

// === –ó–∞–≥—Ä—É–∂–∞–µ–º JSON ===
fetch("lessons.json")
  .then(res => res.json())
  .then(data => {
    lessonsDB = data;
    generateLevelsMenu();
    addSettingsMenu();
  })
  .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ JSON:", err));

// === –ú–µ–Ω—é ===
document.getElementById("menuBtn").addEventListener("click", () => {
  document.getElementById("menuDropdown").classList.toggle("show");
});

// === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Ä–æ–≤–Ω–µ–π –∏ —É—Ä–æ–∫–æ–≤ ===
function generateLevelsMenu() {
  const menu = document.getElementById("menuDropdown");
  menu.innerHTML = "";
  const finished = getFinishedLessons();

  Object.keys(lessonsDB).forEach(level => {
    const li = document.createElement("li");
    li.classList.add("menu__nav-item");

    const btn = document.createElement("button");
    btn.textContent = level;
    btn.classList.add("level-btn");
    li.appendChild(btn);

    const ul = document.createElement("ul");
    ul.classList.add("submenu");
    ul.style.display = "none";

    Object.keys(lessonsDB[level]).forEach(lessonKey => {
      const lessonLi = document.createElement("li");
      lessonLi.textContent = lessonsDB[level][lessonKey].title;
      lessonLi.style.cursor = "pointer";

      if (finished[level] && finished[level].includes(lessonKey)) {
        lessonLi.style.backgroundColor = "#6fcf97";
        lessonLi.style.color = "#000";
      }

      lessonLi.addEventListener("click", () => {
        startLesson(level, lessonKey);

        if (currentLessonElement) {
          currentLessonElement.style.backgroundColor = "";
          currentLessonElement.style.color = "";
        }
        lessonLi.style.backgroundColor = "#ffd966";
        lessonLi.style.color = "#000";
        currentLessonElement = lessonLi;

        setTimeout(() => {
          document.getElementById("page3").scrollIntoView({ behavior: "smooth", block: "start" });
        }, 300);
      });

      ul.appendChild(lessonLi);
    });

    li.appendChild(ul);
    menu.appendChild(li);

    btn.addEventListener("click", () => {
      const isShown = ul.style.display === "block";
      document.querySelectorAll(".submenu").forEach(sub => sub.style.display = "none");
      ul.style.display = isShown ? "none" : "block";
    });
  });

  const dictBtn = document.createElement("li");
  dictBtn.innerHTML = `<button id="myDictionaryBtn">‚òÖ –ú–æ–π —Å–ª–æ–≤–∞—Ä—å</button>`;
  menu.appendChild(dictBtn);
  document.getElementById("myDictionaryBtn").addEventListener("click", startDictionaryLesson);
}

// === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
function addSettingsMenu() {
  const menu = document.getElementById("menuDropdown");

  const settingsLi = document.createElement("li");
  settingsLi.classList.add("menu__nav-item");

  const settingsBtn = document.createElement("button");
  settingsBtn.textContent = "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏";
  settingsBtn.classList.add("level-btn");
  settingsLi.appendChild(settingsBtn);

  const settingsSubmenu = document.createElement("ul");
  settingsSubmenu.classList.add("submenu");
  settingsSubmenu.style.display = "none";

  const resetExamplesLi = document.createElement("li");
  const resetBtn = document.createElement("button");
  resetBtn.textContent = "–°–±—Ä–æ—Å –ø—Ä–∏–º–µ—Ä–æ–≤";
  resetBtn.style.cursor = "pointer";
  resetBtn.onclick = () => {
    pullExamplesFromJSON = false;
    examples = words.map(() => "");
    alert("–ü—Ä–∏–º–µ—Ä—ã –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ JSON!");
  };
  resetExamplesLi.appendChild(resetBtn);
  settingsSubmenu.appendChild(resetExamplesLi);

  settingsLi.appendChild(settingsSubmenu);
  menu.appendChild(settingsLi);

  settingsBtn.addEventListener("click", () => {
    const isShown = settingsSubmenu.style.display === "block";
    document.querySelectorAll(".submenu").forEach(sub => sub.style.display = "none");
    settingsSubmenu.style.display = isShown ? "none" : "block";
  });
}

// === –ó–∞–ø—É—Å–∫ —É—Ä–æ–∫–∞ –∏–∑ JSON ===
function startLesson(level, lessonKey) {
  const lesson = lessonsDB[level][lessonKey];
  if (!lesson) return;

  currentLesson = { level, lessonKey };
  words = lesson.english;
  transcriptions = lesson.transcriptions;
  translations = lesson.translated;
  examples = pullExamplesFromJSON ? (lesson.example || []) : words.map(() => "");
  currentPhase = 3;
  currentIndex = 0;
  wrongQueue = [];
  startPhase(currentPhase);
  document.getElementById("menuDropdown").classList.remove("show");
}

// === –ó–∞–ø—É—Å–∫ —É—Ä–æ–∫–∞ –∏–∑ —Å–ª–æ–≤–∞—Ä—è ===
function startDictionaryLesson() {
  const dict = getMyDictionary();
  if (dict.length === 0) { alert("–í–∞—à —Å–ª–æ–≤–∞—Ä—å –ø—É—Å—Ç."); return; }

  let foundWords = [], foundTrans = [], foundTransl = [], foundExamples = [];
  for (const word of dict) {
    let found = false;
    for (const levelKey in lessonsDB) {
      for (const lessonKey in lessonsDB[levelKey]) {
        const lesson = lessonsDB[levelKey][lessonKey];
        const idx = lesson.english.indexOf(word);
        if (idx !== -1) {
          foundWords.push(lesson.english[idx]);
          foundTrans.push(lesson.transcriptions[idx] || "");
          foundTransl.push(lesson.translated[idx] || "(–ø–µ—Ä–µ–≤–æ–¥)");
          foundExamples.push(lesson.example ? lesson.example[idx] : "");
          found = true;
          break;
        }
      }
      if (found) break;
    }
    if (!found) {
      foundWords.push(word);
      foundTrans.push("");
      foundTransl.push("(–Ω–µ –Ω–∞–π–¥–µ–Ω–æ)");
      foundExamples.push("");
    }
  }

  words = foundWords;
  transcriptions = foundTrans;
  translations = foundTransl;
  examples = foundExamples;
  currentPhase = 3;
  currentIndex = 0;
  wrongQueue = [];
  hideAllPages();
  startPhase(currentPhase);
  document.getElementById("menuDropdown").classList.remove("show");
}

// === –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã–π –≤–≤–æ–¥ —Å–ª–æ–≤ ===
function goToTranscription() {
  const rawWords = document.getElementById("englishWords").value.trim();
  if (!rawWords) { alert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ"); return; }
  words = rawWords.split("\n").map(s => s.trim());
  transcriptions = words.map(() => "");
  translations = words.map(() => "");
  examples = words.map(() => "");
  hideAllPages();
  document.getElementById("page1_5").classList.remove("hidden");
}

function skipTranscription() {
  transcriptions = words.map(() => "");
  goToTranslations();
}

function goToTranslations() {
  const rawTrans = document.getElementById("englishTranscription").value.trim();
  if (rawTrans) {
    transcriptions = rawTrans.split("\n").map(s => s.trim());
    if (transcriptions.length !== words.length) { alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–ª–æ–≤"); return; }
  } else transcriptions = words.map(() => "");
  hideAllPages();
  document.getElementById("page2").classList.remove("hidden");
}

function startSelfLearning() {
  const rawTransl = document.getElementById("translatedWords").value.trim();
  if (!rawTransl) { alert("–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥—ã"); return; }
  translations = rawTransl.split("\n").map(s => s.trim());
  if (translations.length !== words.length) { alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–ª–æ–≤"); return; }
  examples = words.map(() => "");
  currentPhase = 3;
  currentIndex = 0;
  wrongQueue = [];
  hideAllPages();
  startPhase(currentPhase);
}

// === –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ ===
function hideAllPages() {
  ["page0","page1_5","page2","page3","page4","page5","page6","finishPage"].forEach(id =>
    document.getElementById(id).classList.add("hidden")
  );
}

// === –§–∞–∑—ã ===
function startPhase(phase) {
  hideAllPages();
  currentPhase = phase;
  currentIndex = 0;
  wrongQueue = [];
  updateProgress();

  if (phase === 3) showNextCard();
  if (phase === 4) showPhase2();
  if (phase === 5) showPhase3();
  if (phase === 6) startDictationPhase();
}

// === –ü—Ä–æ–≥—Ä–µ—Å—Å ===
function updateProgress() {
  const total = words.length;
  const done = currentIndex;
  const percent = Math.min(100, Math.round((done / total) * 100));
  document.getElementById("progressText").textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${done}/${total}`;
  document.getElementById("progressBar").style.width = percent + "%";
  document.getElementById("progressBar").textContent = percent + "%";
}

// === –§–∞–∑–∞ 3 (–∫–∞—Ä—Ç–æ—á–∫–∏) ===
function showNextCard() {
  if (currentIndex >= words.length) { goToNextPage(); return; }
  document.getElementById("page3").classList.remove("hidden");
  const word = words[currentIndex];
  document.getElementById("card").innerHTML =
    `<strong>${word}</strong> [${transcriptions[currentIndex]}] ‚Äî ${translations[currentIndex]}
     <button id="speakBtn">üîä</button>
     <button id="addToDictionaryBtn" class="dictionary-btn">${isInDictionary(word) ? "‚òÖ" : "‚òÜ"}</button>`;
  document.getElementById("cardExample").textContent = examples[currentIndex] || "";

  document.getElementById("speakBtn").onclick = () => speakWord(word);
  document.getElementById("addToDictionaryBtn").onclick = () => toggleDictionary(word, document.getElementById("addToDictionaryBtn"));

  currentIndex++;
  updateProgress();
}

// === –§–∞–∑–∞ 4 ===
function showPhase2() {
  if (currentIndex >= words.length && wrongQueue.length === 0) { goToNextPage(); return; }
  document.getElementById("page4").classList.remove("hidden");
  document.getElementById("answerSection").classList.add("hidden");
  const i = getCurrentIndex();
  document.getElementById("phase2-translation").innerHTML = translations[i];
  document.getElementById("phase2-example").textContent = examples[i] || "";
}

function showAnswer() {
  const i = getCurrentIndex();
  const answerContainer = document.getElementById("answerSection");
  document.getElementById("phase2-answer").textContent = `${words[i]} [${transcriptions[i]}]`;
  answerContainer.classList.remove("hidden");

  let btn = document.getElementById("speakPhase4Btn");
  if (!btn) {
    btn = document.createElement("button");
    btn.id = "speakPhase4Btn";
    btn.textContent = "üîä";
    answerContainer.appendChild(btn);
  }
  btn.onclick = () => speakWord(words[i]);
}

function markAnswer(correct) {
  const i = getCurrentIndex();
  if (!correct) wrongQueue.push(i);
  nextIndex();
  showPhase2();
}

// === –§–∞–∑–∞ 5 ===
function showPhase3() {
  if (currentIndex >= words.length && wrongQueue.length === 0) { goToNextPage(); return; }
  document.getElementById("page5").classList.remove("hidden");
  document.getElementById("answerSection3").classList.add("hidden");
  const i = getCurrentIndex();
  document.getElementById("phase3-original").textContent = words[i];
  document.getElementById("phase3-example").textContent = examples[i] || "";
}

function showAnswer3() {
  const i = getCurrentIndex();
  const answerContainer = document.getElementById("answerSection3");
  document.getElementById("phase3-answer").textContent = translations[i];
  answerContainer.classList.remove("hidden");

  let btn = document.getElementById("speakPhase5Btn");
  if (!btn) {
    btn = document.createElement("button");
    btn.id = "speakPhase5Btn";
    btn.textContent = "üîä";
    answerContainer.appendChild(btn);
  }
  btn.onclick = () => speakWord(words[i]);
}

function markAnswer3(correct) {
  const i = getCurrentIndex();
  if (!correct) wrongQueue.push(i);
  nextIndex();
  showPhase3();
}

// === –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
function nextIndex() {
  if (wrongQueue.length > 0) currentIndex = wrongQueue.shift();
  else currentIndex++;
  updateProgress();
}

function getCurrentIndex() {
  return (wrongQueue.length > 0) ? wrongQueue[0] : currentIndex;
}

function goToNextPage() {
  if (currentPhase === 3) startPhase(4);
  else if (currentPhase === 4) startPhase(5);
  else if (currentPhase === 5) startPhase(6);
  else finishLesson();
}

// === –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —ç—Ç–∞–ø ===
function repeatPhase() {
  if (currentPhase > 3) startPhase(currentPhase - 1);
  else startPhase(3);
}

// === –§–∏–Ω–∞–ª —É—Ä–æ–∫–∞ ===
function finishLesson() {
  hideAllPages();
  document.getElementById("finishPage").classList.remove("hidden");
  if (currentLesson) saveFinishedLesson(currentLesson.level, currentLesson.lessonKey);
  generateLevelsMenu();
}

function backToMenu() {
  hideAllPages();
  document.getElementById("page0").classList.remove("hidden");
  document.getElementById("menuDropdown").classList.add("show");
}

// === –î–∏–∫—Ç–∞–Ω—Ç (–§–∞–∑–∞ 6) ===
function startDictationPhase() {
  dictationQueue = words.map((_, i) => i);
  currentIndex = 0;
  dictationWaiting = false;
  showNextDictationWord();
}

function showNextDictationWord() {
  if (dictationQueue.length === 0) { finishLesson(); return; }
  currentIndex = dictationQueue[0];
  dictationWaiting = false;
  hideAllPages();
  const page = document.getElementById("page6");
  page.classList.remove("hidden");
  document.getElementById("dictation-translation").textContent = translations[currentIndex];
  document.getElementById("dictation-example").textContent = examples[currentIndex] || "";
  document.getElementById("dictation-input").value = "";
  document.getElementById("dictation-feedback").textContent = "";

  let btn = document.getElementById("speakDictationBtn");
  if (!btn) {
    btn = document.createElement("button");
    btn.id = "speakDictationBtn";
    btn.textContent = "üîä";
    page.appendChild(btn);
  }
  btn.onclick = () => speakWord(words[currentIndex]);
}

function checkDictation() {
  if (dictationWaiting) return;
  const input = document.getElementById("dictation-input").value.trim();
  if (input.toLowerCase() === words[currentIndex].toLowerCase()) {
    document.getElementById("dictation-feedback").textContent = "‚úÖ –í–µ—Ä–Ω–æ!";
    dictationQueue.shift();
    setTimeout(showNextDictationWord, 600);
  } else {
    document.getElementById("dictation-feedback").textContent = `‚ùå –û—à–∏–±–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${words[currentIndex]}`;
    dictationQueue.push(dictationQueue.shift());
    dictationWaiting = true;
  }
}

function nextDictationAfterError() {
  if (!dictationWaiting) return;
  showNextDictationWord();
}

// === –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ ===
document.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    if (!document.getElementById("page3").classList.contains("hidden")) showNextCard();
    if (!document.getElementById("page4").classList.contains("hidden")) {
      if (document.getElementById("answerSection").classList.contains("hidden")) showAnswer();
      else markAnswer(true);
    }
    if (!document.getElementById("page5").classList.contains("hidden")) {
      if (document.getElementById("answerSection3").classList.contains("hidden")) showAnswer3();
      else markAnswer3(true);
    }
    if (!document.getElementById("page6").classList.contains("hidden")) checkDictation();
  }
  if (e.code === "Space") {
    if (!document.getElementById("page4").classList.contains("hidden")) showAnswer();
    if (!document.getElementById("page5").classList.contains("hidden")) showAnswer3();
  }
});
  // === –§–∞–∑–∞ 4 ===
function markAnswer(correct) {
  const i = currentIndex;
  if (!correct) {
    // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü —Å–ø–∏—Å–∫–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞
    wrongQueue.push(i);
  }
  currentIndex++;
  // –µ—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞, –Ω–∞—á–∏–Ω–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
  if (currentIndex >= words.length && wrongQueue.length > 0) {
    currentIndex = wrongQueue.shift();
  }
  showPhase2();
}

// === –§–∞–∑–∞ 5 ===
function markAnswer3(correct) {
  const i = currentIndex;
  if (!correct) {
    wrongQueue.push(i);
  }
  currentIndex++;
  if (currentIndex >= words.length && wrongQueue.length > 0) {
    currentIndex = wrongQueue.shift();
  }
  showPhase3();
}
// === –§–∞–∑–∞ 4 ===
function markAnswer(correct) {
  if (!correct) {
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–≥–æ —Å–ª–æ–≤–∞ –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞
    wrongQueue.push(currentIndex);
  }
  currentIndex++; // –ò–¥—ë–º –¥–∞–ª—å—à–µ –ø–æ —Å–ª–æ–≤–∞–º
  if (currentIndex >= words.length && wrongQueue.length > 0) {
    // –ö–æ–≥–¥–∞ –¥–æ—à–ª–∏ –¥–æ –∫–æ–Ω—Ü–∞ —Å–ø–∏—Å–∫–∞, –Ω–∞—á–∏–Ω–∞–µ–º –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ—à–∏–±–æ—á–Ω—ã–µ
    currentIndex = wrongQueue.shift();
  }
  showPhase2();
}

// === –§–∞–∑–∞ 5 ===
function markAnswer3(correct) {
  if (!correct) {
    wrongQueue.push(currentIndex);
  }
  currentIndex++;
  if (currentIndex >= words.length && wrongQueue.length > 0) {
    currentIndex = wrongQueue.shift();
  }
  showPhase3();
}

// === –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–ª–æ–≤–∞ ===
function getCurrentIndex() {
  // —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
  return currentIndex;
}
// === –ü—Ä–æ–≥—Ä–µ—Å—Å ===
function updateProgress() {
  const total = words.length;
  const passed = total - (wrongQueue.length + (total - currentIndex));
  const done = Math.max(0, Math.min(total, passed + 1));
  const percent = Math.min(100, Math.round((done / total) * 100));

  const bar = document.getElementById("progressBar");
  const text = document.getElementById("progressText");
  if (bar && text) {
    bar.style.width = percent + "%";
    bar.textContent = percent + "%";
    text.textContent = `–ü—Ä–æ–≥—Ä–µ—Å—Å: ${done}/${total}`;
  }
}

// === –û–±—â–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===
function nextIndex() {
  if (wrongQueue.length > 0) {
    currentIndex = wrongQueue.shift();
  } else {
    currentIndex++;
  }
  updateProgress();
}

// === –§–∞–∑–∞ 4 ===
function markAnswer(correct) {
  if (!correct) {
    wrongQueue.push(currentIndex);
  }
  currentIndex++;

  if (currentIndex >= words.length && wrongQueue.length > 0) {
    currentIndex = wrongQueue.shift();
  }

  updateProgress();
  showPhase2();
}

// === –§–∞–∑–∞ 5 ===
function markAnswer3(correct) {
  if (!correct) {
    wrongQueue.push(currentIndex);
  }
  currentIndex++;

  if (currentIndex >= words.length && wrongQueue.length > 0) {
    currentIndex = wrongQueue.shift();
  }

  updateProgress();
  showPhase3();
}
// === –≠—Ç–∞–ø 4 (–¥–∏–∫—Ç–∞–Ω—Ç ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞) ===
function checkDictation() {
  const i = getCurrentIndex();
  const input = document.getElementById("dictationInput").value.trim();
  const correct = input.toLowerCase() === words[i].toLowerCase();

  const feedback = document.getElementById("dictationFeedback");
  const answerSection = document.getElementById("phase4-answerSection");

  if (correct) {
    feedback.textContent = "‚úÖ –í–µ—Ä–Ω–æ!";
  } else {
    feedback.textContent = `‚ùå –û—à–∏–±–∫–∞. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${words[i]}`;
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Å –æ—Ç–≤–µ—Ç–æ–º
  answerSection.classList.remove("hidden");

  // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –æ–∑–≤—É—á–∫–∏ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
  const existingBtn = document.getElementById("speakDictationBtn");
  if (existingBtn) existingBtn.remove(); // —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é, –µ—Å–ª–∏ –±—ã–ª–∞

  const btn = document.createElement("button");
  btn.id = "speakDictationBtn";
  btn.textContent = "üîä –û–∑–≤—É—á–∏—Ç—å —Å–ª–æ–≤–æ";
  btn.onclick = () => speakWord(words[i]);
  answerSection.appendChild(btn);

  // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —Å–ª–æ–≤—É
  if (!correct) {
    wrongQueue.push(i);
  }
  currentIndex++;
  if (currentIndex >= words.length && wrongQueue.length > 0) {
    currentIndex = wrongQueue.shift();
  }
  updateProgress();
}
// === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ===
function addSettingsMenu() {
  const menu = document.getElementById("menuDropdown");

  const settingsLi = document.createElement("li");
  settingsLi.classList.add("menu__nav-item");

  const settingsBtn = document.createElement("button");
  settingsBtn.textContent = "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏";
  settingsBtn.classList.add("level-btn");
  settingsLi.appendChild(settingsBtn);

  // —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –ø—É—Å—Ç–æ–µ –æ–∫–Ω–æ –ø–æ–¥ –∫–Ω–æ–ø–∫–æ–π
  const settingsWindow = document.createElement("div");
  settingsWindow.id = "settingsWindow";
  settingsWindow.style.display = "none"; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–æ
  settingsWindow.style.padding = "10px";
  settingsWindow.style.marginTop = "5px";
  settingsWindow.style.backgroundColor = "#3a3a3a";
  settingsWindow.style.borderRadius = "5px";

  // –∫–Ω–æ–ø–∫–∞ –≤–Ω—É—Ç—Ä–∏ –æ–∫–Ω–∞
  const resetBtn = document.createElement("button");
  resetBtn.textContent = "–°–±—Ä–æ—Å –ø—Ä–∏–º–µ—Ä–æ–≤";
  resetBtn.style.cursor = "pointer";
  resetBtn.onclick = () => {
    pullExamplesFromJSON = false;
    examples = words.map(() => "");
    alert("–ü—Ä–∏–º–µ—Ä—ã –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ JSON!");
  };

  settingsWindow.appendChild(resetBtn);
  settingsLi.appendChild(settingsWindow);
  menu.appendChild(settingsLi);

  // –ª–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞
  settingsBtn.addEventListener("click", () => {
    const isShown = settingsWindow.style.display === "block";
    // —Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
    document.querySelectorAll("#menuDropdown > li > div").forEach(div => div.style.display = "none");
    settingsWindow.style.display = isShown ? "none" : "block";
  });
}
function addSettingsMenu() {
  const menu = document.getElementById("menuDropdown");

  const settingsLi = document.createElement("li");
  settingsLi.classList.add("menu__nav-item");

  const settingsBtn = document.createElement("button");
  settingsBtn.textContent = "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏";
  settingsBtn.classList.add("level-btn");
  settingsLi.appendChild(settingsBtn);

  const settingsWindow = document.createElement("div");
  settingsWindow.id = "settingsWindow";
  settingsWindow.style.display = "none";
  settingsWindow.style.padding = "10px";
  settingsWindow.style.marginTop = "5px";
  settingsWindow.style.backgroundColor = "#3a3a3a";
  settingsWindow.style.borderRadius = "5px";

  // –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ –ø—Ä–∏–º–µ—Ä–æ–≤
  const resetBtn = document.createElement("button");
  resetBtn.textContent = "–°–±—Ä–æ—Å –ø—Ä–∏–º–µ—Ä–æ–≤";
  resetBtn.style.cursor = "pointer";
  resetBtn.onclick = () => {
    pullExamplesFromJSON = false;
    examples = words.map(() => "");
    alert("–ü—Ä–∏–º–µ—Ä—ã –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ JSON!");
  };
  settingsWindow.appendChild(resetBtn);

  // –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ —Ç–µ–º–∞–º
  const goToThemesBtn = document.createElement("button");
  goToThemesBtn.textContent = "–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ–º–∞–º";
  goToThemesBtn.style.cursor = "pointer";
  goToThemesBtn.style.marginTop = "5px";
  goToThemesBtn.onclick = () => {
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –º–µ–Ω—é
    hideAllPages();
    document.getElementById("page0").classList.remove("hidden");
    document.getElementById("menuDropdown").classList.add("show");
  };
  settingsWindow.appendChild(goToThemesBtn);

  settingsLi.appendChild(settingsWindow);
  menu.appendChild(settingsLi);

  // –õ–æ–≥–∏–∫–∞ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
  settingsBtn.addEventListener("click", () => {
    const isShown = settingsWindow.style.display === "block";
    document.querySelectorAll("#menuDropdown > li > div").forEach(div => div.style.display = "none");
    settingsWindow.style.display = isShown ? "none" : "block";
  });
}
function addSettingsMenu() {
  const menu = document.getElementById("menuDropdown");

  const settingsLi = document.createElement("li");
  settingsLi.classList.add("menu__nav-item");

  const settingsBtn = document.createElement("button");
  settingsBtn.textContent = "‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏";
  settingsBtn.classList.add("level-btn");
  settingsLi.appendChild(settingsBtn);

  const settingsWindow = document.createElement("div");
  settingsWindow.id = "settingsWindow";
  settingsWindow.style.display = "none";
  settingsWindow.style.position = "relative"; // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
  settingsWindow.style.zIndex = "10"; // –ø–æ–≤–µ—Ä—Ö –º–µ–Ω—é
  settingsWindow.style.padding = "10px";
  settingsWindow.style.marginTop = "5px";
  settingsWindow.style.backgroundColor = "#3a3a3a";
  settingsWindow.style.borderRadius = "5px";

  const resetBtn = document.createElement("button");
  resetBtn.textContent = "–°–±—Ä–æ—Å –ø—Ä–∏–º–µ—Ä–æ–≤";
  resetBtn.style.display = "block";
  resetBtn.style.width = "100%";
  resetBtn.style.marginBottom = "5px";
  resetBtn.onclick = () => {
    pullExamplesFromJSON = false;
    examples = words.map(() => "");
    alert("–ü—Ä–∏–º–µ—Ä—ã –±–æ–ª—å—à–µ –Ω–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞—é—Ç—Å—è –∏–∑ JSON!");
  };
  settingsWindow.appendChild(resetBtn);

  const goToThemesBtn = document.createElement("button");
  goToThemesBtn.textContent = "–ü–µ—Ä–µ–π—Ç–∏ –∫ —Ç–µ–º–∞–º";
  goToThemesBtn.style.display = "block";
  goToThemesBtn.style.width = "100%";
  goToThemesBtn.onclick = () => {
    hideAllPages();
    document.getElementById("page0").classList.remove("hidden");
    document.getElementById("menuDropdown").classList.add("show");
  };
  settingsWindow.appendChild(goToThemesBtn);

  settingsLi.appendChild(settingsWindow);
  menu.appendChild(settingsLi);

  settingsBtn.addEventListener("click", () => {
    const isShown = settingsWindow.style.display === "block";
    document.querySelectorAll("#menuDropdown > li > div").forEach(div => div.style.display = "none");
    settingsWindow.style.display = isShown ? "none" : "block";
  });
}


</script>

</body>
</html>
