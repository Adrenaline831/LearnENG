<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LearnENG</title>
</head>
<body>

<!-- –ú–µ–Ω—é -->
<div class="menu">
  <button onclick="toggleMenu()">‚ò∞ –ú–µ–Ω—é</button>
  <div class="dropdown" id="menuDropdown"></div>
</div>

<!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
<div id="progressText"></div>
<div id="progressBarContainer">
  <div id="progressBar">0%</div>
</div>

<!-- –°—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div id="page1">
  <h2>–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–∏–µ —Å–ª–æ–≤–∞</h2>
  <textarea id="englishWords" rows="8" placeholder="cat&#10;dog&#10;pig"></textarea>
  <button onclick="goToTranscription()">–î–∞–ª—å—à–µ</button>
</div>

<div id="page1_5" style="display:none;">
  <h2>–í–≤–µ–¥–∏—Ç–µ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é</h2>
  <textarea id="englishTranscription" rows="8" placeholder="k√¶t&#10;d…íg&#10;p…™g"></textarea>
  <button onclick="skipTranscription()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é</button>
  <button onclick="goToTranslations()">–î–∞–ª—å—à–µ</button>
</div>

<div id="page2" style="display:none;">
  <h2>–í–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥—ã</h2>
  <textarea id="translatedWords" rows="8" placeholder="–∫–æ—Ç&#10;—Å–æ–±–∞–∫–∞&#10;—Å–≤–∏–Ω—å—è"></textarea>
  <button onclick="startPhase1()">–ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ</button>
</div>

<div id="page3" style="display:none;">
  <h2>–§–∞–∑–∞ 1: –û–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ</h2>
  <p id="card"></p>
  <button onclick="showNextCard()">–î–∞–ª–µ–µ</button>
  <button onclick="goToNextPage()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø</button>
</div>

<div id="page4" style="display:none;">
  <h2>–§–∞–∑–∞ 2: –ü–µ—Ä–µ–≤–æ–¥ ‚Üí –û—Ä–∏–≥–∏–Ω–∞–ª</h2>
  <p id="phase2-translation"></p>
  <button id="showAnswerBtn" onclick="showAnswer()">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
  <div id="answerSection" style="display:none;">
    <p id="phase2-answer"></p>
    <button onclick="markAnswer(true)">‚úÖ</button>
    <button onclick="markAnswer(false)">‚ùå</button>
    <button onclick="goToNextPage()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø</button>
  </div>
</div>

<div id="page5" style="display:none;">
  <h2>–§–∞–∑–∞ 3: –û—Ä–∏–≥–∏–Ω–∞–ª ‚Üí –ü–µ—Ä–µ–≤–æ–¥</h2>
  <p id="phase3-original"></p>
  <button id="showAnswerBtn3" onclick="showAnswer3()">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
  <div id="answerSection3" style="display:none;">
    <p id="phase3-answer"></p>
    <button onclick="markAnswer3(true)">‚úÖ</button>
    <button onclick="markAnswer3(false)">‚ùå</button>
    <button onclick="goToNextPage()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø</button>
  </div>
</div>

<div id="page6" style="display:none;">
  <h2>–§–∞–∑–∞ 4: –î–∏–∫—Ç–∞–Ω—Ç</h2>
  <p id="dictation-translation"></p>
  <input type="text" id="dictation-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–Ω–≥–ª–∏–π—Å–∫–æ–µ —Å–ª–æ–≤–æ">
  <button onclick="checkDictation()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
  <button onclick="goToNextPage()">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø</button>
  <p id="dictation-feedback"></p>
</div>

<script>
let english = [];
let transcriptions = [];
let translated = [];
let examples = [];
let currentIndex = 0;

// --- –ú–µ–Ω—é ---
function toggleMenu() {
  const menu = document.getElementById("menuDropdown");
  menu.style.display = (menu.style.display === "none" || menu.style.display === "") ? "block" : "none";
}

document.addEventListener("DOMContentLoaded", () => {
  loadMenu();
});

// --- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –º–µ–Ω—é –∏–∑ JSON ---
function loadMenu() {
  fetch("lessons.json")
    .then(res => res.json())
    .then(data => {
      const menu = document.getElementById("menuDropdown");
      menu.innerHTML = "";
      Object.keys(data).forEach(levelId => {
        const levelDiv = document.createElement("div");
        levelDiv.classList.add("has-sub");
        levelDiv.innerHTML = `<strong>${levelId}</strong><div class="submenu" style="display:none;"></div>`;
        const submenu = levelDiv.querySelector(".submenu");

        Object.keys(data[levelId]).forEach(lessonKey => {
          const lessonDiv = document.createElement("div");
          lessonDiv.classList.add("lesson-item");
          lessonDiv.innerText = data[levelId][lessonKey].title;
          lessonDiv.addEventListener("click", () => loadLesson(levelId, lessonKey));
          submenu.appendChild(lessonDiv);
        });

        menu.appendChild(levelDiv);
      });

      // –ü–æ–¥–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö –ø–æ–¥–º–µ–Ω—é
      document.querySelectorAll(".has-sub").forEach(item => {
        item.addEventListener("click", function(e){
          const submenu = this.querySelector(".submenu");
          submenu.style.display = (submenu.style.display === "none" || submenu.style.display === "") ? "block" : "none";
          e.stopPropagation();
        });
      });
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–Ω—é:", err));
}

// --- –†–∞–Ω–¥–æ–º –ø–æ—Ä—è–¥–æ–∫ —Å–ª–æ–≤ ---
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// --- –ü—Ä–æ–≥—Ä–µ—Å—Å ---
function updateProgress(done, total, phaseName) {
  const percent = Math.round((done/total)*100);
  document.getElementById("progressText").innerText = `${phaseName}: ${done} / ${total}`;
  document.getElementById("progressBar").style.width = percent + "%";
  document.getElementById("progressBar").innerText = percent + "%";
}

// --- –í–≤–æ–¥ —Å–ª–æ–≤ –∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π ---
function goToTranscription(){
  const text = document.getElementById("englishWords").value.trim();
  english = text.split('\n').map(w=>w.trim()).filter(w=>w);
  if(!english.length){ alert("–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ —Å–ª–æ–≤–æ."); return;}
  document.getElementById("page1").style.display="none";
  document.getElementById("page1_5").style.display="block";
}

function skipTranscription() {
  transcriptions = english.map(()=> "");
  document.getElementById("page1_5").style.display="none";
  document.getElementById("page2").style.display="block";
}

function goToTranslations() {
  const text = document.getElementById("englishTranscription").value.trim();
  if(text) {
    transcriptions = text.split('\n').map(w=>w.trim());
    if(transcriptions.length !== english.length){
      alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–π –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–ª–æ–≤."); return;
    }
  } else { transcriptions = english.map(()=> ""); }
  document.getElementById("page1_5").style.display="none";
  document.getElementById("page2").style.display="block";
}

// --- –§–∞–∑–∞ 1 ---
function startPhase1() {
  const text = document.getElementById("translatedWords").value.trim();
  translated = text.split('\n').map(w=>w.trim()).filter(w=>w);
  if(translated.length !== english.length){
    alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤."); return;
  }
  document.getElementById("page2").style.display="none";
  document.getElementById("page3").style.display="block";
  currentIndex=0;
  showNextCard();
}

function showNextCard(){
  if(currentIndex>=english.length){
    document.getElementById("page3").style.display="none";
    startPhase2(); return;
  }
  const eng = english[currentIndex];
  const transcr = transcriptions[currentIndex] ? `[${transcriptions[currentIndex]}]` : "";
  const rus = translated[currentIndex];
  const exampleText = (examples[currentIndex] && examples[currentIndex].length>=2)? `<br><small>–ü—Ä–∏–º–µ—Ä: ${examples[currentIndex][0]} ‚Äî ${examples[currentIndex][1]}</small>` : "";
  document.getElementById("card").innerHTML = `<strong>${eng}</strong> ${transcr}<br>${rus}${exampleText}`;
  currentIndex++;
  updateProgress(currentIndex, english.length, "–§–∞–∑–∞ 1");
}

// --- –§–∞–∑–∞ 2 ---
let queue2=[], currentPair2=null;
function startPhase2() {
  document.getElementById("page4").style.display="block";
  queue2 = english.map((w,i)=>({eng:w, rus:translated[i], transcr:transcriptions[i]}));
  queue2 = shuffleArray(queue2);
  nextPhase2Card();
}

function nextPhase2Card(){
  if(queue2.length===0){ document.getElementById("page4").style.display="none"; startPhase3(); return; }
  currentPair2 = queue2.shift();
  document.getElementById("phase2-translation").innerText = currentPair2.rus;
  document.getElementById("phase2-answer").innerText = `${currentPair2.eng} ${currentPair2.transcr ? "["+currentPair2.transcr+"]" : ""}`;
  document.getElementById("answerSection").style.display="none";
  document.getElementById("showAnswerBtn").style.display="inline-block";
  updateProgress(english.length - queue2.length, english.length, "–§–∞–∑–∞ 2");
}

function showAnswer(){ document.getElementById("answerSection").style.display="block"; document.getElementById("showAnswerBtn").style.display="none"; }
function markAnswer(correct){ if(!correct) queue2.push(currentPair2); nextPhase2Card(); }

// --- –§–∞–∑–∞ 3 ---
let queue3=[], currentPair3=null;
function startPhase3(){
  document.getElementById("page5").style.display="block";
  queue3 = english.map((w,i)=>({eng:w, rus:translated[i], transcr:transcriptions[i]}));
  queue3 = shuffleArray(queue3);
  nextPhase3Card();
}
function nextPhase3Card(){
  if(queue3.length===0){ startPhase4(); return; }
  currentPair3 = queue3.shift();
  document.getElementById("phase3-original").innerText = currentPair3.eng;
  document.getElementById("phase3-answer").innerText = `${currentPair3.rus} ${currentPair3.transcr ? "["+currentPair3.transcr+"]" : ""}`;
  document.getElementById("answerSection3").style.display="none";
  document.getElementById("showAnswerBtn3").style.display="inline-block";
  updateProgress(english.length - queue3.length, english.length, "–§–∞–∑–∞ 3");
}
function showAnswer3(){ document.getElementById("answerSection3").style.display="block"; document.getElementById("showAnswerBtn3").style.display="none"; }
function markAnswer3(correct){ if(!correct) queue3.push(currentPair3); nextPhase3Card(); }

// --- –§–∞–∑–∞ 4 ---
let queue4=[], currentPair4=null;
function startPhase4(){
  document.getElementById("page5").style.display="none";
  document.getElementById("page6").style.display="block";
  queue4 = english.map((w,i)=>({eng:w, rus:translated[i], transcr:transcriptions[i]}));
  queue4 = shuffleArray(queue4);
  nextDictationCard();
}
function nextDictationCard(){
  document.getElementById("dictation-feedback").innerText="";
  document.getElementById("dictation-input").value="";
  document.getElementById("dictation-input").style.display="block";
  if(queue4.length===0){
    document.getElementById("dictation-translation").innerText="–§–∞–∑–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! üéâ";
    document.getElementById("dictation-input").style.display="none";
    updateProgress(english.length, english.length, "–§–∞–∑–∞ 4");
    return;
  }
  currentPair4 = queue4.shift();
  document.getElementById("dictation-translation").innerText=currentPair4.rus;
  updateProgress(english.length - queue4.length, english.length, "–§–∞–∑–∞ 4");
}
function checkDictation(){
  const userInput = document.getElementById("dictation-input").value.trim().toLowerCase();
  const correctAnswer = currentPair4.eng.toLowerCase();
  if(userInput === correctAnswer){
    document.getElementById("dictation-feedback").innerText = `‚úÖ –í–µ—Ä–Ω–æ! ${currentPair4.eng} ${currentPair4.transcr ? "["+currentPair4.transcr+"]" : ""}`;
  } else {
    document.getElementById("dictation-feedback").innerText = `‚ùå –ù–µ–≤–µ—Ä–Ω–æ. –ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${currentPair4.eng} ${currentPair4.transcr ? "["+currentPair4.transcr+"]" : ""}`;
    queue4.push(currentPair4);
  }
  setTimeout(()=>{ nextDictationCard(); }, 1000);
}

// --- –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç—Ç–∞–ø" ---
function goToNextPage(){
  if(document.getElementById("page3").style.display==="block"){ document.getElementById("page3").style.display="none"; startPhase2(); }
  else if(document.getElementById("page4").style.display==="block"){ document.getElementById("page4").style.display="none"; startPhase3(); }
  else if(document.getElementById("page5").style.display==="block"){ document.getElementById("page5").style.display="none"; startPhase4(); }
}

// --- –ó–∞–≥—Ä—É–∑–∫–∞ —É—Ä–æ–∫–∞ –∏–∑ JSON ---
function loadLesson(levelId, lessonKey){
  fetch("lessons.json")
    .then(res => res.json())
    .then(data => {
      const lesson = data[levelId] ? data[levelId][lessonKey] : null;
      if(!lesson){ alert("–£—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω!"); return; }

      english = lesson.english || [];
      transcriptions = lesson.transcriptions || [];
      translated = lesson.translated || [];
      examples = lesson.example || [];

      document.getElementById("menuDropdown").style.display="none";
      document.querySelectorAll("div[id^='page']").forEach(div=>div.style.display="none");
      currentIndex=0;
      document.getElementById("page3").style.display="block";
      showNextCard();
    })
    .catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Ä–æ–∫–∞:", err));
}
</script>
</body>
</html>
