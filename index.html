<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LearnENG</title>
</head>
<body>

<!-- Меню -->
<div class="menu">
  <button onclick="toggleMenu()">☰ Меню</button>
  <div class="dropdown" id="menuDropdown"></div>
</div>

<!-- Прогресс -->
<div id="progressText"></div>
<div id="progressBarContainer">
  <div id="progressBar">0%</div>
</div>

<!-- Страницы -->
<div id="page1">
  <h2>Введите английские слова</h2>
  <textarea id="englishWords" rows="8" placeholder="cat&#10;dog&#10;pig"></textarea>
  <button onclick="goToTranscription()">Дальше</button>
</div>

<div id="page1_5" style="display:none;">
  <h2>Введите транскрипцию</h2>
  <textarea id="englishTranscription" rows="8" placeholder="kæt&#10;dɒg&#10;pɪg"></textarea>
  <button onclick="skipTranscription()">Пропустить транскрипцию</button>
  <button onclick="goToTranslations()">Дальше</button>
</div>

<div id="page2" style="display:none;">
  <h2>Введите переводы</h2>
  <textarea id="translatedWords" rows="8" placeholder="кот&#10;собака&#10;свинья"></textarea>
  <button onclick="startPhase1()">Начать обучение</button>
</div>

<div id="page3" style="display:none;">
  <h2>Фаза 1: Ознакомление</h2>
  <p id="card"></p>
  <button onclick="showNextCard()">Далее</button>
  <button onclick="goToNextPage()">Пропустить этап</button>
</div>

<div id="page4" style="display:none;">
  <h2>Фаза 2: Перевод → Оригинал</h2>
  <p id="phase2-translation"></p>
  <button id="showAnswerBtn" onclick="showAnswer()">Показать ответ</button>
  <div id="answerSection" style="display:none;">
    <p id="phase2-answer"></p>
    <button onclick="markAnswer(true)">✅</button>
    <button onclick="markAnswer(false)">❌</button>
    <button onclick="goToNextPage()">Пропустить этап</button>
  </div>
</div>

<div id="page5" style="display:none;">
  <h2>Фаза 3: Оригинал → Перевод</h2>
  <p id="phase3-original"></p>
  <button id="showAnswerBtn3" onclick="showAnswer3()">Показать ответ</button>
  <div id="answerSection3" style="display:none;">
    <p id="phase3-answer"></p>
    <button onclick="markAnswer3(true)">✅</button>
    <button onclick="markAnswer3(false)">❌</button>
    <button onclick="goToNextPage()">Пропустить этап</button>
  </div>
</div>

<div id="page6" style="display:none;">
  <h2>Фаза 4: Диктант</h2>
  <p id="dictation-translation"></p>
  <input type="text" id="dictation-input" placeholder="Введите английское слово">
  <button onclick="checkDictation()">Проверить</button>
  <button onclick="goToNextPage()">Пропустить этап</button>
  <p id="dictation-feedback"></p>
</div>

<script>
let english = [];
let transcriptions = [];
let translated = [];
let examples = [];
let currentIndex = 0;

// --- Меню ---
function toggleMenu() {
  const menu = document.getElementById("menuDropdown");
  menu.style.display = (menu.style.display === "none" || menu.style.display === "") ? "block" : "none";
}

document.addEventListener("DOMContentLoaded", () => {
  loadMenu();
});

// --- Динамическое меню из JSON ---
function loadMenu() {
  fetch("lessons.json")
    .then(res => res.json())
    .then(data => {
      const menu = document.getElementById("menuDropdown");
      menu.innerHTML = "";
      Object.keys(data).forEach(levelId => {
        const levelDiv = document.createElement("div");
        levelDiv.classList.add("has-sub");
        levelDiv.innerHTML = `<strong>${levelId}</strong><div class="submenu" style="display:none;"></div>`;
        const submenu = levelDiv.querySelector(".submenu");

        Object.keys(data[levelId]).forEach(lessonKey => {
          const lessonDiv = document.createElement("div");
          lessonDiv.classList.add("lesson-item");
          lessonDiv.innerText = data[levelId][lessonKey].title;
          lessonDiv.addEventListener("click", () => loadLesson(levelId, lessonKey));
          submenu.appendChild(lessonDiv);
        });

        menu.appendChild(levelDiv);
      });

      // Подключаем клики для выпадающих подменю
      document.querySelectorAll(".has-sub").forEach(item => {
        item.addEventListener("click", function(e){
          const submenu = this.querySelector(".submenu");
          submenu.style.display = (submenu.style.display === "none" || submenu.style.display === "") ? "block" : "none";
          e.stopPropagation();
        });
      });
    })
    .catch(err => console.error("Ошибка загрузки меню:", err));
}

// --- Рандом порядок слов ---
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// --- Прогресс ---
function updateProgress(done, total, phaseName) {
  const percent = Math.round((done/total)*100);
  document.getElementById("progressText").innerText = `${phaseName}: ${done} / ${total}`;
  document.getElementById("progressBar").style.width = percent + "%";
  document.getElementById("progressBar").innerText = percent + "%";
}

// --- Ввод слов и транскрипций ---
function goToTranscription(){
  const text = document.getElementById("englishWords").value.trim();
  english = text.split('\n').map(w=>w.trim()).filter(w=>w);
  if(!english.length){ alert("Введите хотя бы одно слово."); return;}
  document.getElementById("page1").style.display="none";
  document.getElementById("page1_5").style.display="block";
}

function skipTranscription() {
  transcriptions = english.map(()=> "");
  document.getElementById("page1_5").style.display="none";
  document.getElementById("page2").style.display="block";
}

function goToTranslations() {
  const text = document.getElementById("englishTranscription").value.trim();
  if(text) {
    transcriptions = text.split('\n').map(w=>w.trim());
    if(transcriptions.length !== english.length){
      alert("Количество транскрипций не совпадает с количеством слов."); return;
    }
  } else { transcriptions = english.map(()=> ""); }
  document.getElementById("page1_5").style.display="none";
  document.getElementById("page2").style.display="block";
}

// --- Фаза 1 ---
function startPhase1() {
  const text = document.getElementById("translatedWords").value.trim();
  translated = text.split('\n').map(w=>w.trim()).filter(w=>w);
  if(translated.length !== english.length){
    alert("Количество переводов не совпадает с количеством английских слов."); return;
  }
  document.getElementById("page2").style.display="none";
  document.getElementById("page3").style.display="block";
  currentIndex=0;
  showNextCard();
}

function showNextCard(){
  if(currentIndex>=english.length){
    document.getElementById("page3").style.display="none";
    startPhase2(); return;
  }
  const eng = english[currentIndex];
  const transcr = transcriptions[currentIndex] ? `[${transcriptions[currentIndex]}]` : "";
  const rus = translated[currentIndex];
  const exampleText = (examples[currentIndex] && examples[currentIndex].length>=2)? `<br><small>Пример: ${examples[currentIndex][0]} — ${examples[currentIndex][1]}</small>` : "";
  document.getElementById("card").innerHTML = `<strong>${eng}</strong> ${transcr}<br>${rus}${exampleText}`;
  currentIndex++;
  updateProgress(currentIndex, english.length, "Фаза 1");
}

// --- Фаза 2 ---
let queue2=[], currentPair2=null;
function startPhase2() {
  document.getElementById("page4").style.display="block";
  queue2 = english.map((w,i)=>({eng:w, rus:translated[i], transcr:transcriptions[i]}));
  queue2 = shuffleArray(queue2);
  nextPhase2Card();
}

function nextPhase2Card(){
  if(queue2.length===0){ document.getElementById("page4").style.display="none"; startPhase3(); return; }
  currentPair2 = queue2.shift();
  document.getElementById("phase2-translation").innerText = currentPair2.rus;
  document.getElementById("phase2-answer").innerText = `${currentPair2.eng} ${currentPair2.transcr ? "["+currentPair2.transcr+"]" : ""}`;
  document.getElementById("answerSection").style.display="none";
  document.getElementById("showAnswerBtn").style.display="inline-block";
  updateProgress(english.length - queue2.length, english.length, "Фаза 2");
}

function showAnswer(){ document.getElementById("answerSection").style.display="block"; document.getElementById("showAnswerBtn").style.display="none"; }
function markAnswer(correct){ if(!correct) queue2.push(currentPair2); nextPhase2Card(); }

// --- Фаза 3 ---
let queue3=[], currentPair3=null;
function startPhase3(){
  document.getElementById("page5").style.display="block";
  queue3 = english.map((w,i)=>({eng:w, rus:translated[i], transcr:transcriptions[i]}));
  queue3 = shuffleArray(queue3);
  nextPhase3Card();
}
function nextPhase3Card(){
  if(queue3.length===0){ startPhase4(); return; }
  currentPair3 = queue3.shift();
  document.getElementById("phase3-original").innerText = currentPair3.eng;
  document.getElementById("phase3-answer").innerText = `${currentPair3.rus} ${currentPair3.transcr ? "["+currentPair3.transcr+"]" : ""}`;
  document.getElementById("answerSection3").style.display="none";
  document.getElementById("showAnswerBtn3").style.display="inline-block";
  updateProgress(english.length - queue3.length, english.length, "Фаза 3");
}
function showAnswer3(){ document.getElementById("answerSection3").style.display="block"; document.getElementById("showAnswerBtn3").style.display="none"; }
function markAnswer3(correct){ if(!correct) queue3.push(currentPair3); nextPhase3Card(); }

// --- Фаза 4 ---
let queue4=[], currentPair4=null;
function startPhase4(){
  document.getElementById("page5").style.display="none";
  document.getElementById("page6").style.display="block";
  queue4 = english.map((w,i)=>({eng:w, rus:translated[i], transcr:transcriptions[i]}));
  queue4 = shuffleArray(queue4);
  nextDictationCard();
}
function nextDictationCard(){
  document.getElementById("dictation-feedback").innerText="";
  document.getElementById("dictation-input").value="";
  document.getElementById("dictation-input").style.display="block";
  if(queue4.length===0){
    document.getElementById("dictation-translation").innerText="Фаза завершена! 🎉";
    document.getElementById("dictation-input").style.display="none";
    updateProgress(english.length, english.length, "Фаза 4");
    return;
  }
  currentPair4 = queue4.shift();
  document.getElementById("dictation-translation").innerText=currentPair4.rus;
  updateProgress(english.length - queue4.length, english.length, "Фаза 4");
}
function checkDictation(){
  const userInput = document.getElementById("dictation-input").value.trim().toLowerCase();
  const correctAnswer = currentPair4.eng.toLowerCase();
  if(userInput === correctAnswer){
    document.getElementById("dictation-feedback").innerText = `✅ Верно! ${currentPair4.eng} ${currentPair4.transcr ? "["+currentPair4.transcr+"]" : ""}`;
  } else {
    document.getElementById("dictation-feedback").innerText = `❌ Неверно. Правильно: ${currentPair4.eng} ${currentPair4.transcr ? "["+currentPair4.transcr+"]" : ""}`;
    queue4.push(currentPair4);
  }
  setTimeout(()=>{ nextDictationCard(); }, 1000);
}

// --- Общая функция для кнопки "Пропустить этап" ---
function goToNextPage(){
  if(document.getElementById("page3").style.display==="block"){ document.getElementById("page3").style.display="none"; startPhase2(); }
  else if(document.getElementById("page4").style.display==="block"){ document.getElementById("page4").style.display="none"; startPhase3(); }
  else if(document.getElementById("page5").style.display==="block"){ document.getElementById("page5").style.display="none"; startPhase4(); }
}

// --- Загрузка урока из JSON ---
function loadLesson(levelId, lessonKey){
  fetch("lessons.json")
    .then(res => res.json())
    .then(data => {
      const lesson = data[levelId] ? data[levelId][lessonKey] : null;
      if(!lesson){ alert("Урок не найден!"); return; }

      english = lesson.english || [];
      transcriptions = lesson.transcriptions || [];
      translated = lesson.translated || [];
      examples = lesson.example || [];

      document.getElementById("menuDropdown").style.display="none";
      document.querySelectorAll("div[id^='page']").forEach(div=>div.style.display="none");
      currentIndex=0;
      document.getElementById("page3").style.display="block";
      showNextCard();
    })
    .catch(err => console.error("Ошибка загрузки урока:", err));
}
</script>
</body>
</html>
